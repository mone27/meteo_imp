<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="need to implement custom data preparation pipeline and loss function">

<title>meteo_imp - Implement Kalman model using FastAI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="meteo_imp - Implement Kalman model using FastAI">
<meta property="og:description" content="need to implement custom data preparation pipeline and loss function">
<meta property="og:site-name" content="meteo_imp">
<meta name="twitter:title" content="meteo_imp - Implement Kalman model using FastAI">
<meta name="twitter:description" content="need to implement custom data preparation pipeline and loss function">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">meteo_imp</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Implement Kalman model using FastAI</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">GPFA Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_preparation.html" class="sidebar-item-text sidebar-link">Data Preparation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../results.html" class="sidebar-item-text sidebar-link">Results</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simplegp_imputation.html" class="sidebar-item-text sidebar-link">Simple GP Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gaussian.html" class="sidebar-item-text sidebar-link">Gaussian Distributions Utils</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils.html" class="sidebar-item-text sidebar-link">Utils</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Fluxnet</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/gap_finder.html" class="sidebar-item-text sidebar-link">Find Gaps in Fluxnet data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/hainich.html" class="sidebar-item-text sidebar-link">Fluxnet Hainich</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">GPFA</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/gpfa.html" class="sidebar-item-text sidebar-link">Gaussian Processes Factor Analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/learner.html" class="sidebar-item-text sidebar-link">GPFA Learner</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/imputation.html" class="sidebar-item-text sidebar-link">Imputation time series</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">kalman</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter.html" class="sidebar-item-text sidebar-link">Kalman Filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/test_filter_pykalman.html" class="sidebar-item-text sidebar-link">Compare PyKalman</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/fastai.html" class="sidebar-item-text sidebar-link active">Implement Kalman model using FastAI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/learner.html" class="sidebar-item-text sidebar-link">Kalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/imputation.html" class="sidebar-item-text sidebar-link">Imputation Kalman Model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old statsmodels - statespace.html" class="sidebar-item-text sidebar-link">[Not Working] StatsModels Kalman filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_01_pykalman_models.html" class="sidebar-item-text sidebar-link">[OLD] PyKalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_02_pykalman_imputation.html" class="sidebar-item-text sidebar-link">[OLD] Imputation PyKalman Model</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link active" data-scroll-target="#data-preparation">Data Preparation</a>
  <ul class="collapse">
  <li><a href="#blocks" id="toc-blocks" class="nav-link" data-scroll-target="#blocks">Blocks</a></li>
  <li><a href="#blockdftransform" id="toc-blockdftransform" class="nav-link" data-scroll-target="#blockdftransform">BlockDfTransform</a></li>
  <li><a href="#gaps" id="toc-gaps" class="nav-link" data-scroll-target="#gaps">Gaps</a></li>
  <li><a href="#addgaptransform" id="toc-addgaptransform" class="nav-link" data-scroll-target="#addgaptransform">AddGapTransform</a></li>
  <li><a href="#maskeddf.tidy" id="toc-maskeddf.tidy" class="nav-link" data-scroll-target="#maskeddf.tidy">MaskedDf.tidy</a></li>
  <li><a href="#maskeddf.show" id="toc-maskeddf.show" class="nav-link" data-scroll-target="#maskeddf.show">MaskedDf.show</a></li>
  <li><a href="#to-tensor" id="toc-to-tensor" class="nav-link" data-scroll-target="#to-tensor">To Tensor</a></li>
  <li><a href="#normalsparams" id="toc-normalsparams" class="nav-link" data-scroll-target="#normalsparams">NormalsParams</a></li>
  <li><a href="#maskedtensor" id="toc-maskedtensor" class="nav-link" data-scroll-target="#maskedtensor">MaskedTensor</a></li>
  <li><a href="#maskeddf2tensor" id="toc-maskeddf2tensor" class="nav-link" data-scroll-target="#maskeddf2tensor">MaskedDf2Tensor</a></li>
  <li><a href="#normalize" id="toc-normalize" class="nav-link" data-scroll-target="#normalize">Normalize</a></li>
  <li><a href="#get_stats" id="toc-get_stats" class="nav-link" data-scroll-target="#get_stats">get_stats</a></li>
  <li><a href="#normalizemasked" id="toc-normalizemasked" class="nav-link" data-scroll-target="#normalizemasked">NormalizeMasked</a></li>
  <li><a href="#pipeline" id="toc-pipeline" class="nav-link" data-scroll-target="#pipeline">Pipeline</a></li>
  <li><a href="#imp_pipeline" id="toc-imp_pipeline" class="nav-link" data-scroll-target="#imp_pipeline">imp_pipeline</a></li>
  <li><a href="#dataloader" id="toc-dataloader" class="nav-link" data-scroll-target="#dataloader">Dataloader</a></li>
  <li><a href="#make_dataloader" id="toc-make_dataloader" class="nav-link" data-scroll-target="#make_dataloader">make_dataloader</a></li>
  </ul></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a>
  <ul class="collapse">
  <li><a href="#forward-function" id="toc-forward-function" class="nav-link" data-scroll-target="#forward-function">Forward Function</a></li>
  <li><a href="#kalmanfilter.forward" id="toc-kalmanfilter.forward" class="nav-link" data-scroll-target="#kalmanfilter.forward">KalmanFilter.forward</a></li>
  <li><a href="#loss-function" id="toc-loss-function" class="nav-link" data-scroll-target="#loss-function">Loss Function</a></li>
  <li><a href="#kalmanloss" id="toc-kalmanloss" class="nav-link" data-scroll-target="#kalmanloss">KalmanLoss</a></li>
  <li><a href="#metrics" id="toc-metrics" class="nav-link" data-scroll-target="#metrics">Metrics</a></li>
  <li><a href="#to_meteo_imp_metric" id="toc-to_meteo_imp_metric" class="nav-link" data-scroll-target="#to_meteo_imp_metric">to_meteo_imp_metric</a></li>
  <li><a href="#callback" id="toc-callback" class="nav-link" data-scroll-target="#callback">Callback</a></li>
  <li><a href="#saveparams" id="toc-saveparams" class="nav-link" data-scroll-target="#saveparams">SaveParams</a></li>
  <li><a href="#saveparams-1" id="toc-saveparams-1" class="nav-link" data-scroll-target="#saveparams-1">SaveParams</a></li>
  <li><a href="#learner" id="toc-learner" class="nav-link" data-scroll-target="#learner">Learner</a></li>
  </ul></li>
  <li><a href="#float64" id="toc-float64" class="nav-link" data-scroll-target="#float64">Float64</a>
  <ul class="collapse">
  <li><a href="#float64callback" id="toc-float64callback" class="nav-link" data-scroll-target="#float64callback">Float64Callback</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mone27/meteo_imp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Implement Kalman model using FastAI</h1>
</div>

<div>
  <div class="description">
    need to implement custom data preparation pipeline and loss function
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<p>The aim of the data preparation pipeline is to: - take the original time series and split it into time blocks - for each block generate a random gap (need to figure out the properties of the gap) - split some time blocks for testing</p>
<p>the input of the pipeline is: - a dataframe containing all observations</p>
<p>the input of the model is: - observed data (potentially containing NaN where data is missing) - missing data mask (which is telling where the data is missing) - the data needs to be standardized</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.core <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.data.core <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"full_hai"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(dtype<span class="op">=</span>np.float32):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> read_fluxnet_csv(hai_path, <span class="va">None</span>, num_dtype<span class="op">=</span>dtype)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>hai <span class="op">=</span> load_data()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>hai64 <span class="op">=</span> load_data(np.float64)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="blocks" class="level3">
<h3 class="anchored" data-anchor-id="blocks">Blocks</h3>
<p>the first step is to transfrom the original dataframe into blocks of a specified <code>block_len</code></p>
<p>two different strategies are possible:</p>
<ul>
<li>contigous blocks</li>
<li>random block in the dataframe</li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L28" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="blockdftransform" class="level3">
<h3 class="anchored" data-anchor-id="blockdftransform">BlockDfTransform</h3>
<blockquote class="blockquote">
<pre><code> BlockDfTransform (df, block_len=200)</code></pre>
</blockquote>
<p>divide timeseries DataFrame into blocks</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> BlockDfTransform(hai[:<span class="dv">100</span>], <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>BlockDfTransform:
encodes: (int,object) -&gt; encodes
decodes: </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>m(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>TA</th>
      <th>SW_IN</th>
      <th>VPD</th>
    </tr>
    <tr>
      <th>time</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-01 05:30:00</th>
      <td>-0.23</td>
      <td>0.00</td>
      <td>0.138</td>
    </tr>
    <tr>
      <th>2000-01-01 06:00:00</th>
      <td>-0.23</td>
      <td>0.00</td>
      <td>0.122</td>
    </tr>
    <tr>
      <th>2000-01-01 06:30:00</th>
      <td>-0.22</td>
      <td>0.00</td>
      <td>0.098</td>
    </tr>
    <tr>
      <th>2000-01-01 07:00:00</th>
      <td>-0.24</td>
      <td>0.00</td>
      <td>0.066</td>
    </tr>
    <tr>
      <th>2000-01-01 07:30:00</th>
      <td>-0.23</td>
      <td>0.00</td>
      <td>0.044</td>
    </tr>
    <tr>
      <th>2000-01-01 08:00:00</th>
      <td>-0.22</td>
      <td>0.00</td>
      <td>0.026</td>
    </tr>
    <tr>
      <th>2000-01-01 08:30:00</th>
      <td>-0.19</td>
      <td>0.45</td>
      <td>0.016</td>
    </tr>
    <tr>
      <th>2000-01-01 09:00:00</th>
      <td>-0.14</td>
      <td>3.70</td>
      <td>0.010</td>
    </tr>
    <tr>
      <th>2000-01-01 09:30:00</th>
      <td>-0.03</td>
      <td>7.26</td>
      <td>0.006</td>
    </tr>
    <tr>
      <th>2000-01-01 10:00:00</th>
      <td>0.04</td>
      <td>12.24</td>
      <td>0.006</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>m(<span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>TA</th>
      <th>SW_IN</th>
      <th>VPD</th>
    </tr>
    <tr>
      <th>time</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-02 21:30:00</th>
      <td>0.97</td>
      <td>0.0</td>
      <td>0.192</td>
    </tr>
    <tr>
      <th>2000-01-02 22:00:00</th>
      <td>0.85</td>
      <td>0.0</td>
      <td>0.149</td>
    </tr>
    <tr>
      <th>2000-01-02 22:30:00</th>
      <td>0.77</td>
      <td>0.0</td>
      <td>0.112</td>
    </tr>
    <tr>
      <th>2000-01-02 23:00:00</th>
      <td>0.63</td>
      <td>0.0</td>
      <td>0.075</td>
    </tr>
    <tr>
      <th>2000-01-02 23:30:00</th>
      <td>0.52</td>
      <td>0.0</td>
      <td>0.038</td>
    </tr>
    <tr>
      <th>2000-01-03 00:00:00</th>
      <td>0.48</td>
      <td>0.0</td>
      <td>0.021</td>
    </tr>
    <tr>
      <th>2000-01-03 00:30:00</th>
      <td>0.41</td>
      <td>0.0</td>
      <td>0.013</td>
    </tr>
    <tr>
      <th>2000-01-03 01:00:00</th>
      <td>0.29</td>
      <td>0.0</td>
      <td>0.004</td>
    </tr>
    <tr>
      <th>2000-01-03 01:30:00</th>
      <td>0.31</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-03 02:00:00</th>
      <td>0.42</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="gaps" class="level3">
<h3 class="anchored" data-anchor-id="gaps">Gaps</h3>
<p>adds a mask which includes a random gap</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _make_random_gap(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    gap_length: <span class="bu">int</span>, <span class="co"># The length of the gap</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    total_length: <span class="bu">int</span>, <span class="co"># The total number of observations</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    gap_start: <span class="bu">int</span> <span class="op">=</span> <span class="va">None</span> <span class="co"># Optional start of gap</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>): <span class="co"># (total_length) array of bools to indicicate if the data is missing or not</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add a continous gap of ginve length at random position"</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(gap_length <span class="op">&gt;=</span> total_length):</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.repeat(<span class="va">True</span>, total_length)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    gap_start <span class="op">=</span> np.random.randint(total_length <span class="op">-</span> gap_length) <span class="cf">if</span> gap_start <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> gap_start</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.hstack([</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        np.repeat(<span class="va">False</span>, gap_start),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        np.repeat(<span class="va">True</span>, gap_length),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        np.repeat(<span class="va">False</span>, total_length <span class="op">-</span> (gap_length <span class="op">+</span> gap_start))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L67" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="addgaptransform" class="level3">
<h3 class="anchored" data-anchor-id="addgaptransform">AddGapTransform</h3>
<blockquote class="blockquote">
<pre><code> AddGapTransform (variables, gap_length)</code></pre>
</blockquote>
<p>Adds a random gap to a <code>TimeSTensor</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>a_gap <span class="op">=</span> AddGapTransform([<span class="st">'TA'</span>, <span class="st">'VPD'</span>], <span class="dv">5</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>a_gap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>AddGapTransform:
encodes: (DataFrame,object) -&gt; encodes
decodes: </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>a_gap(m(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>MaskedDf(data=                       TA  SW_IN    VPD
time                                   
2000-01-01 05:30:00 -0.23   0.00  0.138
2000-01-01 06:00:00 -0.23   0.00  0.122
2000-01-01 06:30:00 -0.22   0.00  0.098
2000-01-01 07:00:00 -0.24   0.00  0.066
2000-01-01 07:30:00 -0.23   0.00  0.044
2000-01-01 08:00:00 -0.22   0.00  0.026
2000-01-01 08:30:00 -0.19   0.45  0.016
2000-01-01 09:00:00 -0.14   3.70  0.010
2000-01-01 09:30:00 -0.03   7.26  0.006
2000-01-01 10:00:00  0.04  12.24  0.006, mask=                        TA  SW_IN    VPD
time                                    
2000-01-01 05:30:00   True   True   True
2000-01-01 06:00:00   True   True   True
2000-01-01 06:30:00   True   True   True
2000-01-01 07:00:00  False   True  False
2000-01-01 07:30:00  False   True  False
2000-01-01 08:00:00  False   True  False
2000-01-01 08:30:00  False   True  False
2000-01-01 09:00:00  False   True  False
2000-01-01 09:30:00   True   True   True
2000-01-01 10:00:00   True   True   True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>m_df <span class="op">=</span> a_gap(m(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>m_df.data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>TA</th>
      <th>SW_IN</th>
      <th>VPD</th>
    </tr>
    <tr>
      <th>time</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-01 15:30:00</th>
      <td>0.52</td>
      <td>8.09</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-01 16:00:00</th>
      <td>0.57</td>
      <td>6.37</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-01 16:30:00</th>
      <td>0.73</td>
      <td>1.72</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-01 17:00:00</th>
      <td>0.77</td>
      <td>0.06</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-01 17:30:00</th>
      <td>0.84</td>
      <td>0.00</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-01 18:00:00</th>
      <td>0.99</td>
      <td>0.00</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-01 18:30:00</th>
      <td>1.35</td>
      <td>0.00</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2000-01-01 19:00:00</th>
      <td>1.86</td>
      <td>0.00</td>
      <td>0.002</td>
    </tr>
    <tr>
      <th>2000-01-01 19:30:00</th>
      <td>2.01</td>
      <td>0.00</td>
      <td>0.009</td>
    </tr>
    <tr>
      <th>2000-01-01 20:00:00</th>
      <td>2.07</td>
      <td>0.00</td>
      <td>0.014</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>m_df.mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>TA</th>
      <th>SW_IN</th>
      <th>VPD</th>
    </tr>
    <tr>
      <th>time</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2000-01-01 15:30:00</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2000-01-01 16:00:00</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2000-01-01 16:30:00</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2000-01-01 17:00:00</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2000-01-01 17:30:00</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2000-01-01 18:00:00</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2000-01-01 18:30:00</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2000-01-01 19:00:00</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2000-01-01 19:30:00</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2000-01-01 20:00:00</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L83" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="maskeddf.tidy" class="level3">
<h3 class="anchored" data-anchor-id="maskeddf.tidy">MaskedDf.tidy</h3>
<blockquote class="blockquote">
<pre><code> MaskedDf.tidy ()</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>m_df.tidy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>time</th>
      <th>variable</th>
      <th>value</th>
      <th>is_present</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2000-01-01 15:30:00</td>
      <td>TA</td>
      <td>0.520</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000-01-01 16:00:00</td>
      <td>TA</td>
      <td>0.570</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2000-01-01 16:30:00</td>
      <td>TA</td>
      <td>0.730</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2000-01-01 17:00:00</td>
      <td>TA</td>
      <td>0.770</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2000-01-01 17:30:00</td>
      <td>TA</td>
      <td>0.840</td>
      <td>False</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2000-01-01 18:00:00</td>
      <td>TA</td>
      <td>0.990</td>
      <td>True</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2000-01-01 18:30:00</td>
      <td>TA</td>
      <td>1.350</td>
      <td>True</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2000-01-01 19:00:00</td>
      <td>TA</td>
      <td>1.860</td>
      <td>True</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2000-01-01 19:30:00</td>
      <td>TA</td>
      <td>2.010</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2000-01-01 20:00:00</td>
      <td>TA</td>
      <td>2.070</td>
      <td>True</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2000-01-01 15:30:00</td>
      <td>SW_IN</td>
      <td>8.090</td>
      <td>True</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2000-01-01 16:00:00</td>
      <td>SW_IN</td>
      <td>6.370</td>
      <td>True</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2000-01-01 16:30:00</td>
      <td>SW_IN</td>
      <td>1.720</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2000-01-01 17:00:00</td>
      <td>SW_IN</td>
      <td>0.060</td>
      <td>True</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2000-01-01 17:30:00</td>
      <td>SW_IN</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2000-01-01 18:00:00</td>
      <td>SW_IN</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2000-01-01 18:30:00</td>
      <td>SW_IN</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2000-01-01 19:00:00</td>
      <td>SW_IN</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2000-01-01 19:30:00</td>
      <td>SW_IN</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2000-01-01 20:00:00</td>
      <td>SW_IN</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2000-01-01 15:30:00</td>
      <td>VPD</td>
      <td>0.000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2000-01-01 16:00:00</td>
      <td>VPD</td>
      <td>0.000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2000-01-01 16:30:00</td>
      <td>VPD</td>
      <td>0.000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2000-01-01 17:00:00</td>
      <td>VPD</td>
      <td>0.000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2000-01-01 17:30:00</td>
      <td>VPD</td>
      <td>0.000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2000-01-01 18:00:00</td>
      <td>VPD</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2000-01-01 18:30:00</td>
      <td>VPD</td>
      <td>0.000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2000-01-01 19:00:00</td>
      <td>VPD</td>
      <td>0.002</td>
      <td>True</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2000-01-01 19:30:00</td>
      <td>VPD</td>
      <td>0.009</td>
      <td>True</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2000-01-01 20:00:00</td>
      <td>VPD</td>
      <td>0.014</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plot_rug(m_df.tidy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/simone/anaconda3/envs/data-science/lib/python3.10/site-packages/altair/utils/deprecation.py:65: AltairDeprecationWarning: 'add_selection' is deprecated. Use 'add_params' instead.
  warnings.warn(message, AltairDeprecationWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div id="altair-viz-4deb263e135c4f53914058bb9338acb1"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-4deb263e135c4f53914058bb9338acb1") {
      outputDiv = document.getElementById("altair-viz-4deb263e135c4f53914058bb9338acb1");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@5.2.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.2.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-8dbc285ff9e9a0880661cf5960fe4e06"}, "mark": {"type": "tick", "color": "black"}, "encoding": {"color": {"condition": {"value": "white", "test": "datum.is_present"}, "value": "black"}, "x": {"field": "time", "type": "temporal"}}, "params": [{"name": "param_1", "select": {"type": "interval"}, "bind": "scales"}], "$schema": "https://vega.github.io/schema/vega-lite/v5.2.0.json", "datasets": {"data-8dbc285ff9e9a0880661cf5960fe4e06": [{"time": "2000-01-01T15:30:00", "variable": "TA", "value": 0.5199999809265137, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "TA", "value": 0.5699999928474426, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "TA", "value": 0.7300000190734863, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "TA", "value": 0.7699999809265137, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "TA", "value": 0.8399999737739563, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "TA", "value": 0.9900000095367432, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "TA", "value": 1.350000023841858, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "TA", "value": 1.8600000143051147, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "TA", "value": 2.009999990463257, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "TA", "value": 2.069999933242798, "is_present": true}, {"time": "2000-01-01T15:30:00", "variable": "SW_IN", "value": 8.09000015258789, "is_present": true}, {"time": "2000-01-01T16:00:00", "variable": "SW_IN", "value": 6.369999885559082, "is_present": true}, {"time": "2000-01-01T16:30:00", "variable": "SW_IN", "value": 1.7200000286102295, "is_present": true}, {"time": "2000-01-01T17:00:00", "variable": "SW_IN", "value": 0.05999999865889549, "is_present": true}, {"time": "2000-01-01T17:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T15:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "VPD", "value": 0.0020000000949949026, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "VPD", "value": 0.008999999612569809, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "VPD", "value": 0.014000000432133675, "is_present": true}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_points(df, y_label <span class="op">=</span> <span class="st">""</span>, sel <span class="op">=</span> def_selection(), props <span class="op">=</span> {}):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alt.Chart(df).mark_point(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>            strokeWidth <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>            fillOpacity <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        ).encode(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> alt.X(<span class="st">"time"</span>, axis<span class="op">=</span>alt.Axis(domain<span class="op">=</span><span class="va">False</span>, labels <span class="op">=</span> <span class="va">False</span>, ticks<span class="op">=</span><span class="va">False</span>, title<span class="op">=</span><span class="va">None</span>)),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> alt.Y(<span class="st">"value"</span>, title <span class="op">=</span> y_label, scale<span class="op">=</span>alt.Scale(zero<span class="op">=</span><span class="va">False</span>)),</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>            fill<span class="op">=</span> alt.Fill(<span class="st">"is_present"</span>, scale <span class="op">=</span> alt.Scale(<span class="bu">range</span><span class="op">=</span>[<span class="st">"black"</span>, <span class="st">"#ffffff00"</span>]),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                           legend <span class="op">=</span> alt.Legend(title <span class="op">=</span>[<span class="st">"Observed data"</span>])),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            shape <span class="op">=</span> <span class="st">"is_present"</span>,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plot_points(m_df.tidy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-1eb870eba86546c19ccf97b15b98aae9"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-1eb870eba86546c19ccf97b15b98aae9") {
      outputDiv = document.getElementById("altair-viz-1eb870eba86546c19ccf97b15b98aae9");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@5.2.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.2.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-8dbc285ff9e9a0880661cf5960fe4e06"}, "mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "", "type": "quantitative"}}, "$schema": "https://vega.github.io/schema/vega-lite/v5.2.0.json", "datasets": {"data-8dbc285ff9e9a0880661cf5960fe4e06": [{"time": "2000-01-01T15:30:00", "variable": "TA", "value": 0.5199999809265137, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "TA", "value": 0.5699999928474426, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "TA", "value": 0.7300000190734863, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "TA", "value": 0.7699999809265137, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "TA", "value": 0.8399999737739563, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "TA", "value": 0.9900000095367432, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "TA", "value": 1.350000023841858, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "TA", "value": 1.8600000143051147, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "TA", "value": 2.009999990463257, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "TA", "value": 2.069999933242798, "is_present": true}, {"time": "2000-01-01T15:30:00", "variable": "SW_IN", "value": 8.09000015258789, "is_present": true}, {"time": "2000-01-01T16:00:00", "variable": "SW_IN", "value": 6.369999885559082, "is_present": true}, {"time": "2000-01-01T16:30:00", "variable": "SW_IN", "value": 1.7200000286102295, "is_present": true}, {"time": "2000-01-01T17:00:00", "variable": "SW_IN", "value": 0.05999999865889549, "is_present": true}, {"time": "2000-01-01T17:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T15:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "VPD", "value": 0.0020000000949949026, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "VPD", "value": 0.008999999612569809, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "VPD", "value": 0.014000000432133675, "is_present": true}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>plot_line(m_df.tidy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/simone/anaconda3/envs/data-science/lib/python3.10/site-packages/altair/utils/deprecation.py:65: AltairDeprecationWarning: 'add_selection' is deprecated. Use 'add_params' instead.
  warnings.warn(message, AltairDeprecationWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div id="altair-viz-f3776963e9614ee199a3355397a301d4"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-f3776963e9614ee199a3355397a301d4") {
      outputDiv = document.getElementById("altair-viz-f3776963e9614ee199a3355397a301d4");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@5.2.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.2.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-8dbc285ff9e9a0880661cf5960fe4e06"}, "mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "", "type": "quantitative"}}, "params": [{"name": "param_3", "select": {"type": "interval"}, "bind": "scales"}], "$schema": "https://vega.github.io/schema/vega-lite/v5.2.0.json", "datasets": {"data-8dbc285ff9e9a0880661cf5960fe4e06": [{"time": "2000-01-01T15:30:00", "variable": "TA", "value": 0.5199999809265137, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "TA", "value": 0.5699999928474426, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "TA", "value": 0.7300000190734863, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "TA", "value": 0.7699999809265137, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "TA", "value": 0.8399999737739563, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "TA", "value": 0.9900000095367432, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "TA", "value": 1.350000023841858, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "TA", "value": 1.8600000143051147, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "TA", "value": 2.009999990463257, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "TA", "value": 2.069999933242798, "is_present": true}, {"time": "2000-01-01T15:30:00", "variable": "SW_IN", "value": 8.09000015258789, "is_present": true}, {"time": "2000-01-01T16:00:00", "variable": "SW_IN", "value": 6.369999885559082, "is_present": true}, {"time": "2000-01-01T16:30:00", "variable": "SW_IN", "value": 1.7200000286102295, "is_present": true}, {"time": "2000-01-01T17:00:00", "variable": "SW_IN", "value": 0.05999999865889549, "is_present": true}, {"time": "2000-01-01T17:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T15:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "VPD", "value": 0.0020000000949949026, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "VPD", "value": 0.008999999612569809, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "VPD", "value": 0.014000000432133675, "is_present": true}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>plot_variable(m_df.tidy(), <span class="st">"TA"</span>, title<span class="op">=</span><span class="st">"title TA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/simone/anaconda3/envs/data-science/lib/python3.10/site-packages/altair/utils/deprecation.py:65: AltairDeprecationWarning: 'add_selection' is deprecated. Use 'add_params' instead.
  warnings.warn(message, AltairDeprecationWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div id="altair-viz-07da621966114b1da90e950aaf8025fd"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-07da621966114b1da90e950aaf8025fd") {
      outputDiv = document.getElementById("altair-viz-07da621966114b1da90e950aaf8025fd");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@5.2.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.2.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "", "type": "quantitative"}}, "name": "view_1"}], "data": {"name": "data-c216e5a4167f549263b7fefd6be27b9a"}, "params": [{"name": "param_4", "select": {"type": "interval"}, "bind": "scales", "views": ["view_1"]}], "title": "title TA", "$schema": "https://vega.github.io/schema/vega-lite/v5.2.0.json", "datasets": {"data-c216e5a4167f549263b7fefd6be27b9a": [{"time": "2000-01-01T15:30:00", "variable": "TA", "value": 0.5199999809265137, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "TA", "value": 0.5699999928474426, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "TA", "value": 0.7300000190734863, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "TA", "value": 0.7699999809265137, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "TA", "value": 0.8399999737739563, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "TA", "value": 0.9900000095367432, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "TA", "value": 1.350000023841858, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "TA", "value": 1.8600000143051147, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "TA", "value": 2.009999990463257, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "TA", "value": 2.069999933242798, "is_present": true}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L143" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="maskeddf.show" class="level3">
<h3 class="anchored" data-anchor-id="maskeddf.show">MaskedDf.show</h3>
<blockquote class="blockquote">
<pre><code> MaskedDf.show (ax=None, ctx=None, n_cols:int=3,
                bind_interaction:bool=True, props:dict=None)</code></pre>
</blockquote>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ax</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>ctx</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>n_cols</td>
<td>int</td>
<td>3</td>
<td></td>
</tr>
<tr class="even">
<td>bind_interaction</td>
<td>bool</td>
<td>True</td>
<td>Whether the sub-plots for each variable should be connected for zooming/panning</td>
</tr>
<tr class="odd">
<td>props</td>
<td>dict</td>
<td>None</td>
<td>additional properties (eg. size) for altair plot</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Chart</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>m_df.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/simone/anaconda3/envs/data-science/lib/python3.10/site-packages/altair/utils/deprecation.py:65: AltairDeprecationWarning: 'add_selection' is deprecated. Use 'add_params' instead.
  warnings.warn(message, AltairDeprecationWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div id="altair-viz-e665ece4c3684215a806782a924f04fe"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-e665ece4c3684215a806782a924f04fe") {
      outputDiv = document.getElementById("altair-viz-e665ece4c3684215a806782a924f04fe");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@5.2.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.2.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "vconcat": [{"hconcat": [{"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "TA", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "TA", "type": "quantitative"}}, "name": "view_2"}], "height": 100, "title": "TA", "width": 180}, {"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "SW_IN", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "SW_IN", "type": "quantitative"}}, "name": "view_3"}], "data": {"name": "data-c3a60f1c986b6caa7e65dff6e5822e40"}, "height": 100, "title": "SW_IN", "width": 180}, {"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "VPD", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "VPD", "type": "quantitative"}}, "name": "view_4"}], "data": {"name": "data-b515775ddfb81c914376c617816a3fce"}, "height": 100, "title": "VPD", "width": 180}], "data": {"name": "data-c216e5a4167f549263b7fefd6be27b9a"}}, {"hconcat": []}, {"hconcat": []}, {"hconcat": []}], "params": [{"name": "param_5", "select": {"type": "interval", "encodings": ["x"]}, "bind": "scales", "views": ["view_2", "view_3", "view_4"]}], "$schema": "https://vega.github.io/schema/vega-lite/v5.2.0.json", "datasets": {"data-c216e5a4167f549263b7fefd6be27b9a": [{"time": "2000-01-01T15:30:00", "variable": "TA", "value": 0.5199999809265137, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "TA", "value": 0.5699999928474426, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "TA", "value": 0.7300000190734863, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "TA", "value": 0.7699999809265137, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "TA", "value": 0.8399999737739563, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "TA", "value": 0.9900000095367432, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "TA", "value": 1.350000023841858, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "TA", "value": 1.8600000143051147, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "TA", "value": 2.009999990463257, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "TA", "value": 2.069999933242798, "is_present": true}], "data-c3a60f1c986b6caa7e65dff6e5822e40": [{"time": "2000-01-01T15:30:00", "variable": "SW_IN", "value": 8.09000015258789, "is_present": true}, {"time": "2000-01-01T16:00:00", "variable": "SW_IN", "value": 6.369999885559082, "is_present": true}, {"time": "2000-01-01T16:30:00", "variable": "SW_IN", "value": 1.7200000286102295, "is_present": true}, {"time": "2000-01-01T17:00:00", "variable": "SW_IN", "value": 0.05999999865889549, "is_present": true}, {"time": "2000-01-01T17:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}], "data-b515775ddfb81c914376c617816a3fce": [{"time": "2000-01-01T15:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "VPD", "value": 0.0020000000949949026, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "VPD", "value": 0.008999999612569809, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "VPD", "value": 0.014000000432133675, "is_present": true}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>a_gap(m(<span class="dv">3</span>)).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/simone/anaconda3/envs/data-science/lib/python3.10/site-packages/altair/utils/deprecation.py:65: AltairDeprecationWarning: 'add_selection' is deprecated. Use 'add_params' instead.
  warnings.warn(message, AltairDeprecationWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div id="altair-viz-df834de25aaa4cf291a8d59c4e799048"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-df834de25aaa4cf291a8d59c4e799048") {
      outputDiv = document.getElementById("altair-viz-df834de25aaa4cf291a8d59c4e799048");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@5.2.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.2.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "vconcat": [{"hconcat": [{"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "TA", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "TA", "type": "quantitative"}}, "name": "view_5"}], "height": 100, "title": "TA", "width": 180}, {"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "SW_IN", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "SW_IN", "type": "quantitative"}}, "name": "view_6"}], "data": {"name": "data-c3a60f1c986b6caa7e65dff6e5822e40"}, "height": 100, "title": "SW_IN", "width": 180}, {"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "VPD", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "VPD", "type": "quantitative"}}, "name": "view_7"}], "data": {"name": "data-b515775ddfb81c914376c617816a3fce"}, "height": 100, "title": "VPD", "width": 180}], "data": {"name": "data-c216e5a4167f549263b7fefd6be27b9a"}}, {"hconcat": []}, {"hconcat": []}, {"hconcat": []}], "params": [{"name": "param_9", "select": {"type": "interval", "encodings": ["x"]}, "bind": "scales", "views": ["view_5", "view_6", "view_7"]}], "$schema": "https://vega.github.io/schema/vega-lite/v5.2.0.json", "datasets": {"data-c216e5a4167f549263b7fefd6be27b9a": [{"time": "2000-01-01T15:30:00", "variable": "TA", "value": 0.5199999809265137, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "TA", "value": 0.5699999928474426, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "TA", "value": 0.7300000190734863, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "TA", "value": 0.7699999809265137, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "TA", "value": 0.8399999737739563, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "TA", "value": 0.9900000095367432, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "TA", "value": 1.350000023841858, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "TA", "value": 1.8600000143051147, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "TA", "value": 2.009999990463257, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "TA", "value": 2.069999933242798, "is_present": true}], "data-c3a60f1c986b6caa7e65dff6e5822e40": [{"time": "2000-01-01T15:30:00", "variable": "SW_IN", "value": 8.09000015258789, "is_present": true}, {"time": "2000-01-01T16:00:00", "variable": "SW_IN", "value": 6.369999885559082, "is_present": true}, {"time": "2000-01-01T16:30:00", "variable": "SW_IN", "value": 1.7200000286102295, "is_present": true}, {"time": "2000-01-01T17:00:00", "variable": "SW_IN", "value": 0.05999999865889549, "is_present": true}, {"time": "2000-01-01T17:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}], "data-b515775ddfb81c914376c617816a3fce": [{"time": "2000-01-01T15:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T16:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:00:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T17:30:00", "variable": "VPD", "value": 0.0, "is_present": false}, {"time": "2000-01-01T18:00:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T18:30:00", "variable": "VPD", "value": 0.0, "is_present": true}, {"time": "2000-01-01T19:00:00", "variable": "VPD", "value": 0.0020000000949949026, "is_present": true}, {"time": "2000-01-01T19:30:00", "variable": "VPD", "value": 0.008999999612569809, "is_present": true}, {"time": "2000-01-01T20:00:00", "variable": "VPD", "value": 0.014000000432133675, "is_present": true}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>a_gap(m(<span class="dv">4</span>)).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/simone/anaconda3/envs/data-science/lib/python3.10/site-packages/altair/utils/deprecation.py:65: AltairDeprecationWarning: 'add_selection' is deprecated. Use 'add_params' instead.
  warnings.warn(message, AltairDeprecationWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div id="altair-viz-73ff18d2b0c74c1ca910c320401aec6e"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-73ff18d2b0c74c1ca910c320401aec6e") {
      outputDiv = document.getElementById("altair-viz-73ff18d2b0c74c1ca910c320401aec6e");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@5.2.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "5.2.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "vconcat": [{"hconcat": [{"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "TA", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "TA", "type": "quantitative"}}, "name": "view_8"}], "height": 100, "title": "TA", "width": 180}, {"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "SW_IN", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "SW_IN", "type": "quantitative"}}, "name": "view_9"}], "data": {"name": "data-7d75205178a55067427e2ccf76a0ab5a"}, "height": 100, "title": "SW_IN", "width": 180}, {"layer": [{"mark": {"type": "point", "color": "black", "fillOpacity": 1, "strokeWidth": 1}, "encoding": {"fill": {"field": "is_present", "legend": {"title": ["Observed data"]}, "scale": {"range": ["black", "#ffffff00"]}, "type": "nominal"}, "shape": {"field": "is_present", "type": "nominal"}, "x": {"axis": {"domain": false, "labels": false, "ticks": false, "title": null}, "field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "VPD", "type": "quantitative"}}}, {"mark": "line", "encoding": {"color": {"field": "variable", "type": "nominal"}, "x": {"field": "time", "type": "temporal"}, "y": {"field": "value", "scale": {"zero": false}, "title": "VPD", "type": "quantitative"}}, "name": "view_10"}], "data": {"name": "data-c244b9024159e7863ea3c635f61b339c"}, "height": 100, "title": "VPD", "width": 180}], "data": {"name": "data-72246db1d6a0fccd7bbc5eb0b4231bbf"}}, {"hconcat": []}, {"hconcat": []}, {"hconcat": []}], "params": [{"name": "param_13", "select": {"type": "interval", "encodings": ["x"]}, "bind": "scales", "views": ["view_8", "view_9", "view_10"]}], "$schema": "https://vega.github.io/schema/vega-lite/v5.2.0.json", "datasets": {"data-72246db1d6a0fccd7bbc5eb0b4231bbf": [{"time": "2000-01-01T20:30:00", "variable": "TA", "value": 2.0, "is_present": false}, {"time": "2000-01-01T21:00:00", "variable": "TA", "value": 2.190000057220459, "is_present": false}, {"time": "2000-01-01T21:30:00", "variable": "TA", "value": 2.259999990463257, "is_present": false}, {"time": "2000-01-01T22:00:00", "variable": "TA", "value": 2.5299999713897705, "is_present": false}, {"time": "2000-01-01T22:30:00", "variable": "TA", "value": 2.5899999141693115, "is_present": false}, {"time": "2000-01-01T23:00:00", "variable": "TA", "value": 2.5999999046325684, "is_present": true}, {"time": "2000-01-01T23:30:00", "variable": "TA", "value": 2.5299999713897705, "is_present": true}, {"time": "2000-01-02T00:00:00", "variable": "TA", "value": 2.299999952316284, "is_present": true}, {"time": "2000-01-02T00:30:00", "variable": "TA", "value": 2.0799999237060547, "is_present": true}, {"time": "2000-01-02T01:00:00", "variable": "TA", "value": 1.9299999475479126, "is_present": true}], "data-7d75205178a55067427e2ccf76a0ab5a": [{"time": "2000-01-01T20:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T21:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T21:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T22:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T22:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T23:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-01T23:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-02T00:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-02T00:30:00", "variable": "SW_IN", "value": 0.0, "is_present": true}, {"time": "2000-01-02T01:00:00", "variable": "SW_IN", "value": 0.0, "is_present": true}], "data-c244b9024159e7863ea3c635f61b339c": [{"time": "2000-01-01T20:30:00", "variable": "VPD", "value": 0.014000000432133675, "is_present": false}, {"time": "2000-01-01T21:00:00", "variable": "VPD", "value": 0.03799999877810478, "is_present": false}, {"time": "2000-01-01T21:30:00", "variable": "VPD", "value": 0.07900000363588333, "is_present": false}, {"time": "2000-01-01T22:00:00", "variable": "VPD", "value": 0.25699999928474426, "is_present": false}, {"time": "2000-01-01T22:30:00", "variable": "VPD", "value": 0.3880000114440918, "is_present": false}, {"time": "2000-01-01T23:00:00", "variable": "VPD", "value": 0.5550000071525574, "is_present": true}, {"time": "2000-01-01T23:30:00", "variable": "VPD", "value": 0.4519999921321869, "is_present": true}, {"time": "2000-01-02T00:00:00", "variable": "VPD", "value": 0.4350000023841858, "is_present": true}, {"time": "2000-01-02T00:30:00", "variable": "VPD", "value": 0.24799999594688416, "is_present": true}, {"time": "2000-01-02T01:00:00", "variable": "VPD", "value": 0.23399999737739563, "is_present": true}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> L(<span class="op">*</span>m(<span class="dv">1</span>).columns).argwhere(<span class="kw">lambda</span> x: x <span class="kw">in</span> [<span class="st">'TA'</span>,<span class="st">'SW_IN'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.ones_like(m(<span class="dv">1</span>), dtype<span class="op">=</span><span class="bu">bool</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>gap <span class="op">=</span> _make_random_gap(<span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>gap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([False, False,  True,  True, False, False, False, False, False,
       False])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>np.argwhere(gap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[2],
       [3]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>mask[np.argwhere(gap), idx] <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[ True,  True,  True],
       [ True,  True,  True],
       [False, False,  True],
       [False, False,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True],
       [ True,  True,  True]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>mask[gap]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([[False, False,  True],
       [False, False,  True]])</code></pre>
</div>
</div>
</section>
<section id="to-tensor" class="level3">
<h3 class="anchored" data-anchor-id="to-tensor">To Tensor</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L170" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="normalsparams" class="level3">
<h3 class="anchored" data-anchor-id="normalsparams">NormalsParams</h3>
<blockquote class="blockquote">
<pre><code> NormalsParams (x=None, *rest)</code></pre>
</blockquote>
<p>A <code>tuple</code> with elementwise ops and more friendly <strong>init</strong> behavior</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L174" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="maskedtensor" class="level3">
<h3 class="anchored" data-anchor-id="maskedtensor">MaskedTensor</h3>
<blockquote class="blockquote">
<pre><code> MaskedTensor (x=None, *rest)</code></pre>
</blockquote>
<p>A <code>tuple</code> with elementwise ops and more friendly <strong>init</strong> behavior</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L178" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="maskeddf2tensor" class="level3">
<h3 class="anchored" data-anchor-id="maskeddf2tensor">MaskedDf2Tensor</h3>
<blockquote class="blockquote">
<pre><code> MaskedDf2Tensor (enc=None, dec=None, split_idx=None, order=None)</code></pre>
</blockquote>
<p>A transform that always take tuples as items</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tfms <span class="op">=</span> TfmdLists([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>], [BlockDfTransform(hai, <span class="dv">10</span>), AddGapTransform([<span class="st">'TA'</span>,<span class="st">'SW_IN'</span>], <span class="dv">2</span>), MaskedDf2Tensor ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>tfms[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[1.0000e-01, 1.6510e+01, 6.0000e-03],
         [1.8000e-01, 2.4730e+01, 1.1000e-02],
         [2.1000e-01, 4.7420e+01, 1.9000e-02],
         [2.3000e-01, 2.2050e+01, 1.4000e-02],
         [3.3000e-01, 1.8860e+01, 8.0000e-03],
         [4.1000e-01, 2.1100e+01, 6.0000e-03],
         [4.4000e-01, 2.8870e+01, 0.0000e+00],
         [4.8000e-01, 2.4220e+01, 0.0000e+00],
         [4.9000e-01, 2.4350e+01, 0.0000e+00],
         [5.1000e-01, 1.5680e+01, 0.0000e+00]]),
 tensor([[False, False,  True],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(tfms[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>__main__.MaskedTensor</code></pre>
</div>
</div>
</section>
<section id="normalize" class="level3">
<h3 class="anchored" data-anchor-id="normalize">Normalize</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L197" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_stats" class="level3">
<h3 class="anchored" data-anchor-id="get_stats">get_stats</h3>
<blockquote class="blockquote">
<pre><code> get_stats (df)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L201" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="normalizemasked" class="level3">
<h3 class="anchored" data-anchor-id="normalizemasked">NormalizeMasked</h3>
<blockquote class="blockquote">
<pre><code> NormalizeMasked (mean=None, std=None, axes=(0,))</code></pre>
</blockquote>
<p>Normalize/denorm MaskedTensor column-wise</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> TfmdLists([<span class="dv">0</span>,<span class="dv">1</span>], [BlockDfTransform(hai, <span class="dv">10</span>), AddGapTransform([<span class="st">'TA'</span>,<span class="st">'SW_IN'</span>], <span class="dv">2</span>), MaskedDf2Tensor, NormalizeMasked(<span class="op">*</span>get_stats(hai))]).dataloaders(bs<span class="op">=</span><span class="dv">2</span>).one_batch()[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>b[<span class="dv">0</span>].mean(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-1.1083, -0.5929, -0.7457], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>b[<span class="dv">1</span>].mean(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-1.0730, -0.5813, -0.7617], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>b.std(axis<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([0.0232, 0.0154, 0.0128], device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="pipeline" class="level3">
<h3 class="anchored" data-anchor-id="pipeline">Pipeline</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>block_len <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>block_ids <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, (<span class="bu">len</span>(hai) <span class="op">//</span> block_len) <span class="op">-</span> <span class="dv">1</span>))[:<span class="dv">10</span>]</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>gap_len <span class="op">=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L222" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="imp_pipeline" class="level3">
<h3 class="anchored" data-anchor-id="imp_pipeline">imp_pipeline</h3>
<blockquote class="blockquote">
<pre><code> imp_pipeline (df, block_len, gap_len)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>pipeline, block_ids <span class="op">=</span> imp_pipeline(hai, block_len, gap_len)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>pipeline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[BlockDfTransform:
 encodes: (int,object) -&gt; encodes
 decodes: ,
 AddGapTransform:
 encodes: (DataFrame,object) -&gt; encodes
 decodes: ,
 __main__.MaskedDf2Tensor,
 NormalizeMasked:
 encodes: (MaskedTensor,object) -&gt; encodes
 (object,object) -&gt; encodes
 decodes: (NormalsParams,object) -&gt; decodes]</code></pre>
</div>
</div>
</section>
<section id="dataloader" class="level3">
<h3 class="anchored" data-anchor-id="dataloader">Dataloader</h3>
<p>random splitter for validation/training set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>splits <span class="op">=</span> RandomSplitter()(block_ids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Repeat twice the pipeline since is the same pipeline both for training data and for labels</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> Datasets(block_ids, [pipeline, pipeline], splits<span class="op">=</span>splits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ds.dataloaders(bs<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>dls.device</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>device(type='cuda', index=0)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>dls.one_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>((tensor([[[-0.2693, -0.5929, -0.6567],
           [-0.2983, -0.5929, -0.6633],
           [-0.3134, -0.5929, -0.6821],
           [-0.3160, -0.5929, -0.6864],
           [-0.3450, -0.5929, -0.6912],
           [-0.3740, -0.5929, -0.6954],
           [-0.3929, -0.5929, -0.7002],
           [-0.4144, -0.5929, -0.7032],
           [-0.3866, -0.5761, -0.7027],
           [-0.3563, -0.5083, -0.7016]]], device='cuda:0'),
  tensor([[[ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [False, False,  True],
           [False, False,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True]]], device='cuda:0')),
 (tensor([[[-0.2693, -0.5929, -0.6567],
           [-0.2983, -0.5929, -0.6633],
           [-0.3134, -0.5929, -0.6821],
           [-0.3160, -0.5929, -0.6864],
           [-0.3450, -0.5929, -0.6912],
           [-0.3740, -0.5929, -0.6954],
           [-0.3929, -0.5929, -0.7002],
           [-0.4144, -0.5929, -0.7032],
           [-0.3866, -0.5761, -0.7027],
           [-0.3563, -0.5083, -0.7016]]], device='cuda:0'),
  tensor([[[False, False,  True],
           [False, False,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True],
           [ True,  True,  True]]], device='cuda:0')))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="at">@typedispatch</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_batch(x: MaskedTensor, y, samples, ctxs<span class="op">=</span><span class="va">None</span>, max_n<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(tensor([[[ 0.2784, -0.2709, -0.7263],
         [ 0.2910, -0.1753, -0.6858],
         [ 0.3024, -0.1056, -0.6617],
         [ 0.3200,  0.1098, -0.6555],
         [ 0.3478,  0.1037, -0.6054],
         [ 0.3756,  0.1350, -0.5244],
         [ 0.3554, -0.3939, -0.5908],
         [ 0.3263, -0.2356, -0.6983],
         [ 0.3074, -0.4015, -0.7116],
         [ 0.2658,  0.1273, -0.6956]]]), tensor([[[ True,  True,  True],
         [False, False,  True],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>dls._types</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{tuple: [{__main__.MaskedTensor: [torch.Tensor, torch.Tensor]},
  {__main__.MaskedTensor: [torch.Tensor, torch.Tensor]}]}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(tensor([[[ 0.2443, -0.5929, -0.7366],
         [ 0.3238, -0.5929, -0.7240],
         [ 0.3629, -0.5929, -0.6306],
         [ 0.3402, -0.5929, -0.6594],
         [ 0.3213, -0.5929, -0.6912],
         [ 0.3188, -0.5929, -0.6965],
         [ 0.3137, -0.5929, -0.6887],
         [ 0.3162, -0.5929, -0.6727],
         [ 0.3465, -0.5929, -0.5706],
         [ 0.3692, -0.5929, -0.4811]]]), tensor([[[ True,  True,  True],
         [False, False,  True],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>Datasets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>fastai.data.core.Datasets</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L233" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="make_dataloader" class="level3">
<h3 class="anchored" data-anchor-id="make_dataloader">make_dataloader</h3>
<blockquote class="blockquote">
<pre><code> make_dataloader (df, block_len, gap_len, bs=10)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> make_dataloader(hai, <span class="dv">200</span>, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>dls.one_batch()[<span class="dv">0</span>][<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([10, 200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dls.cpu()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<section id="forward-function" class="level3">
<h3 class="anchored" data-anchor-id="forward-function">Forward Function</h3>
<p>in order to the a pytorch module we need a forward method to the kalman filter</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L259" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.forward" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.forward">KalmanFilter.forward</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.forward (masked_data:__main__.MaskedTensor)</code></pre>
</blockquote>
<p>Defines the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note:: Although the recipe for forward pass needs to be defined within this function, one should call the :class:<code>Module</code> instance afterwards instead of this since the former takes care of running the registered hooks while the latter silently ignores them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="bu">input</span> <span class="op">=</span> dls.one_batch()[<span class="dv">0</span>]</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> dls.one_batch()[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> KalmanFilter.init_simple(n_dim <span class="op">=</span> hai.shape[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>model.state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('trans_matrix',
              tensor([[1., 0., 0.],
                      [0., 1., 0.],
                      [0., 0., 1.]])),
             ('trans_off', tensor([0., 0., 0.])),
             ('trans_cov_raw',
              tensor([[1., 0., 0.],
                      [0., 1., 0.],
                      [0., 0., 1.]])),
             ('obs_matrix',
              tensor([[1., 0., 0.],
                      [0., 1., 0.],
                      [0., 0., 1.]])),
             ('obs_off', tensor([0., 0., 0.])),
             ('obs_cov_raw',
              tensor([[1., 0., 0.],
                      [0., 1., 0.],
                      [0., 0., 1.]])),
             ('init_state_mean', tensor([0., 0., 0.])),
             ('init_state_cov_raw',
              tensor([[1., 0., 0.],
                      [0., 1., 0.],
                      [0., 0., 1.]]))])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="bu">input</span>[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>data.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> <span class="bu">input</span>[<span class="dv">1</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>data.device</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>device(type='cpu')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>torch.device</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.device</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>data.shape, mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([200, 3]), torch.Size([200, 3]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>model.predict(data, mask)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>model.use_smooth <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> model(<span class="bu">input</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>pred[<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([10, 200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>pred[<span class="dv">1</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([10, 200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>model.use_smooth <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>pred_filt <span class="op">=</span> model(<span class="bu">input</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>pred_filt[<span class="dv">1</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([10, 200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>test_ne(pred, pred_filt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loss-function" class="level3">
<h3 class="anchored" data-anchor-id="loss-function">Loss Function</h3>
<p>add support for complete loss (also outside gap) and for filter loss (dont run the smooher)</p>
<p>TODO document: - only_gap - only_std</p>
<p>Play around with flatting + diagonal</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> torch.diag(torch.tensor([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]))</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> torch.stack([a, a<span class="op">*</span><span class="dv">10</span>])</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> torch.stack([a.diag(), a.diag()<span class="op">*</span><span class="dv">10</span>])</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 1,  0,  0],
         [ 0,  2,  0],
         [ 0,  0,  3]],

        [[10,  0,  0],
         [ 0, 20,  0],
         [ 0,  0, 30]]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>m.flatten()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([ 1,  2,  3, 10, 20, 30])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 1,  0,  0],
         [ 0,  2,  0],
         [ 0,  0,  3]],

        [[10,  0,  0],
         [ 0, 20,  0],
         [ 0,  0, 30]]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>torch.diagonal(d, dim1<span class="op">=</span><span class="dv">1</span>, dim2<span class="op">=</span><span class="dv">2</span>).flatten()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([ 1,  2,  3, 10, 20, 30])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>means, stds <span class="op">=</span> pred</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>data, mask <span class="op">=</span> target</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a big matrix with all variables and observations and compute ll</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> mask.flatten() </span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>obs <span class="op">=</span> data.flatten()[mask]</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> data.flatten()[mask]</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>stds <span class="op">=</span> stds.flatten()[mask] <span class="co"># need to support batches</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>MultivariateNormal(means, torch.diag(stds)).log_prob(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(-5926.1069, grad_fn=&lt;SubBackward0&gt;)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L268" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanloss" class="level3">
<h3 class="anchored" data-anchor-id="kalmanloss">KalmanLoss</h3>
<blockquote class="blockquote">
<pre><code> KalmanLoss (only_gap:bool=True)</code></pre>
</blockquote>
<p>Initialize self. See help(type(self)) for accurate signature.</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>only_gap</td>
<td>bool</td>
<td>True</td>
<td>loss for all predictions or only gap?</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>means, stds <span class="op">=</span> pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>stds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([10, 200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>means.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([10, 200, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>data.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(False)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>mask.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(False)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>means.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(False)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>stds.isnan().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(0)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>stds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1.1756, 1.1756, 1.1756],
         [1.1990, 1.1990, 1.1990],
         [1.2024, 1.2024, 1.2024],
         ...,
         [1.2045, 1.2045, 1.2045],
         [1.2133, 1.2133, 1.2133],
         [1.2720, 1.2720, 1.2720]],

        [[1.1756, 1.1756, 1.1756],
         [1.1990, 1.1990, 1.1990],
         [1.2024, 1.2024, 1.2024],
         ...,
         [1.2045, 1.2045, 1.2045],
         [1.2133, 1.2133, 1.2133],
         [1.2720, 1.2720, 1.2720]],

        [[1.1756, 1.1756, 1.1756],
         [1.1990, 1.1990, 1.1990],
         [1.2024, 1.2024, 1.2024],
         ...,
         [1.2045, 1.2045, 1.2045],
         [1.2133, 1.2133, 1.2133],
         [1.2720, 1.2720, 1.2720]],

        ...,

        [[1.1756, 1.1756, 1.1756],
         [1.1990, 1.1990, 1.1990],
         [1.2024, 1.2024, 1.2024],
         ...,
         [1.2045, 1.2045, 1.2045],
         [1.2133, 1.2133, 1.2133],
         [1.2720, 1.2720, 1.2720]],

        [[1.1818, 1.1818, 1.1818],
         [1.2532, 1.2532, 1.2532],
         [1.5461, 1.5461, 1.5461],
         ...,
         [1.2045, 1.2045, 1.2045],
         [1.2133, 1.2133, 1.2133],
         [1.2720, 1.2720, 1.2720]],

        [[1.1756, 1.1756, 1.1756],
         [1.1990, 1.1990, 1.1990],
         [1.2024, 1.2024, 1.2024],
         ...,
         [1.2045, 1.2045, 1.2045],
         [1.2133, 1.2133, 1.2133],
         [1.2720, 1.2720, 1.2720]]], grad_fn=&lt;SqrtBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>is_posdef_eigv(torch.diag(stds.flatten()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor(True),
 tensor([1.1756, 1.1756, 1.1756,  ..., 2.0096, 2.0096, 2.0096],
        grad_fn=&lt;LinalgEighBackward0&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>KalmanLoss(only_gap<span class="op">=</span><span class="va">True</span>)(pred, target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-5926.1074], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>KalmanLoss(only_gap<span class="op">=</span><span class="va">False</span>)(pred, target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-6132.7500], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="metrics" class="level3">
<h3 class="anchored" data-anchor-id="metrics">Metrics</h3>
<p>Wrapper around fastai metrics to support masked tensors and normal distributions</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L288" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="to_meteo_imp_metric" class="level3">
<h3 class="anchored" data-anchor-id="to_meteo_imp_metric">to_meteo_imp_metric</h3>
<blockquote class="blockquote">
<pre><code> to_meteo_imp_metric (metric)</code></pre>
</blockquote>
</section>
<section id="callback" class="level3">
<h3 class="anchored" data-anchor-id="callback">Callback</h3>
<p>save the model state</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L306" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="saveparams" class="level3">
<h3 class="anchored" data-anchor-id="saveparams">SaveParams</h3>
<blockquote class="blockquote">
<pre><code> SaveParams (param_name)</code></pre>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L306" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="saveparams-1" class="level3">
<h3 class="anchored" data-anchor-id="saveparams-1">SaveParams</h3>
<blockquote class="blockquote">
<pre><code> SaveParams (param_name)</code></pre>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>
</section>
<section id="learner" class="level3">
<h3 class="anchored" data-anchor-id="learner">Learner</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>obs_cov_history <span class="op">=</span> SaveParams(<span class="st">'obs_cov'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>all_data <span class="op">=</span> CollectDataCallback()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> KalmanFilter.init_random(n_dim_obs <span class="op">=</span> hai.shape[<span class="dv">1</span>], n_dim_state <span class="op">=</span> hai.shape[<span class="dv">1</span>]).cuda()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>model.use_smooth <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model._set_constraint('obs_cov', model.obs_cov, train=False)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> make_dataloader(hai[:<span class="dv">20000</span>], <span class="dv">200</span>, <span class="dv">10</span>, bs<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="bu">input</span>, target <span class="op">=</span> dls.one_batch()</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> model(<span class="bu">input</span>)</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>KalmanLoss()(pred, target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>AssertionError: </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, model, loss_func<span class="op">=</span>KalmanLoss(only_gap<span class="op">=</span><span class="va">False</span>), cbs <span class="op">=</span> [] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>learn.fit(<span class="dv">10</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-6241.285645</td>
      <td>-6166.921875</td>
      <td>00:04</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>learn.model.state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('trans_matrix',
              tensor([[ 0.2328,  0.2904,  0.8642],
                      [ 0.1481,  0.3370, -0.0706],
                      [ 0.5228,  0.9285,  0.0213]])),
             ('trans_off', tensor([0.7417, 0.3526, 0.8808])),
             ('trans_cov_raw',
              tensor([[ 1.4564,  0.0792, -0.0779],
                      [ 0.9506,  0.3046,  0.0806],
                      [ 1.0371, -0.6069,  0.6328]])),
             ('obs_matrix',
              tensor([[-0.0369,  0.4501,  1.0446],
                      [ 0.1179,  0.7037,  1.0001],
                      [ 0.1294,  0.6732,  0.8144]])),
             ('obs_off', tensor([0.9110, 0.6074, 0.8898])),
             ('obs_cov_raw',
              tensor([[ 0.9547,  0.0802, -0.0804],
                      [ 0.6582,  0.8837,  0.0749],
                      [ 0.8048,  0.1688,  0.6803]])),
             ('init_state_mean', tensor([0.5435, 0.1074, 0.9136])),
             ('init_state_cov_raw',
              tensor([[ 0.7809,  0.0803, -0.0781],
                      [ 0.4622,  0.3344,  0.0803],
                      [ 0.9634, -0.2298,  0.4886]]))])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyprojroot <span class="im">import</span> here</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># torch.save(learn.model, here('trained_models'))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>learn.model.obs_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.9244, 0.6933, 0.7272],
        [0.6933, 1.2198, 0.7299],
        [0.7272, 0.7299, 1.1391]], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>learn.model.trans_cov_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Parameter containing:
tensor([[ 1.4564,  0.0792, -0.0779],
        [ 0.9506,  0.3046,  0.0806],
        [ 1.0371, -0.6069,  0.6328]], requires_grad=True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>obs_cov_history.params[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>torch.tensor(<span class="bu">list</span>(<span class="bu">map</span>(symmetric_upto, obs_cov_history.params)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>torch.linalg.eigvalsh(obs_cov_history.params[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>torch.linalg.cholesky_ex(obs_cov_history.params[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>tt <span class="op">=</span> torch.tensor([[ <span class="fl">1.0696</span>,  <span class="fl">0.5199</span>, <span class="op">-</span><span class="fl">0.5249</span>],</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>        [ <span class="fl">0.5484</span>,  <span class="fl">1.1091</span>,  <span class="fl">0.5322</span>],</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">0.5279</span>,  <span class="fl">0.5506</span>,  <span class="fl">1.0742</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>torch.linalg.eigvalsh(tt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>symmetric_upto(tt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># torch.save(learn.model.state_dict(), "partial_traning_15_dec_not_pos_def_error")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>learn.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># learn.lr_find()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>display_as_row(learn.model.get_info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="float64" class="level2">
<h2 class="anchored" data-anchor-id="float64">Float64</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>model64 <span class="op">=</span> KalmanFilter.init_random(hai.shape[<span class="dv">1</span>], hai.shape[<span class="dv">1</span>], dtype<span class="op">=</span>torch.float64).cuda()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>dls64 <span class="op">=</span> make_dataloader(hai64, <span class="dv">200</span>, <span class="dv">10</span>, bs<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="bu">input</span> <span class="op">=</span> dls64.one_batch()[<span class="dv">0</span>]</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> dls64.one_batch()[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>data, mask <span class="op">=</span> <span class="bu">input</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>data.device</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>device(type='cuda', index=0)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>data.dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.float64</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>model64.predict(data)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> model64(<span class="bu">input</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>KalmanLoss()(pred, target)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-49087.7748], device='cuda:0', dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/fastai.py#L325" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="float64callback" class="level3">
<h3 class="anchored" data-anchor-id="float64callback">Float64Callback</h3>
<blockquote class="blockquote">
<pre><code> Float64Callback (after_create=None, before_fit=None, before_epoch=None,
                  before_train=None, before_batch=None, after_pred=None,
                  after_loss=None, before_backward=None,
                  after_cancel_backward=None, after_backward=None,
                  before_step=None, after_cancel_step=None,
                  after_step=None, after_cancel_batch=None,
                  after_batch=None, after_cancel_train=None,
                  after_train=None, before_validate=None,
                  after_cancel_validate=None, after_validate=None,
                  after_cancel_epoch=None, after_epoch=None,
                  after_cancel_fit=None, after_fit=None)</code></pre>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>model64.use_smooth <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>learn64 <span class="op">=</span> Learner(dls64, model64, loss_func<span class="op">=</span>KalmanLoss(), cbs <span class="op">=</span> [ShowGraphCallback, Float64Callback] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>learn64.fit(<span class="dv">10</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-49416.267554</td>
      <td>-45456.064779</td>
      <td>00:47</td>
    </tr>
    <tr>
      <td>1</td>
      <td>-49774.559331</td>
      <td>-46035.058830</td>
      <td>00:54</td>
    </tr>
    <tr>
      <td>2</td>
      <td>-50145.264585</td>
      <td>-46634.220314</td>
      <td>01:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-50534.922409</td>
      <td>-47221.969903</td>
      <td>00:55</td>
    </tr>
    <tr>
      <td>4</td>
      <td>-50944.390999</td>
      <td>-47807.660758</td>
      <td>00:56</td>
    </tr>
    <tr>
      <td>5</td>
      <td>-51373.606669</td>
      <td>-48417.068270</td>
      <td>00:54</td>
    </tr>
    <tr>
      <td>6</td>
      <td>-51819.561213</td>
      <td>-48991.766464</td>
      <td>00:55</td>
    </tr>
    <tr>
      <td>7</td>
      <td>-52281.519413</td>
      <td>-49576.808954</td>
      <td>00:54</td>
    </tr>
    <tr>
      <td>8</td>
      <td>-52758.569444</td>
      <td>-50164.191542</td>
      <td>00:57</td>
    </tr>
    <tr>
      <td>9</td>
      <td>-53246.164046</td>
      <td>-50709.250838</td>
      <td>00:55</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-150-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>model64.use_smooth <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>learn64 <span class="op">=</span> Learner(dls64, model64, loss_func<span class="op">=</span>KalmanLoss(only_gap<span class="op">=</span><span class="va">False</span>), cbs <span class="op">=</span> [ShowGraphCallback, Float64Callback] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>learn64.fit(<span class="dv">10</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-77270.886231</td>
      <td>-71040.284828</td>
      <td>00:35</td>
    </tr>
    <tr>
      <td>1</td>
      <td>-77798.197806</td>
      <td>-71921.237880</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>2</td>
      <td>-78352.764396</td>
      <td>-72796.284893</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-78933.527870</td>
      <td>-73668.896829</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>4</td>
      <td>-79539.178430</td>
      <td>-74536.184364</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>5</td>
      <td>-80169.233572</td>
      <td>-75395.285302</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>6</td>
      <td>-80821.635679</td>
      <td>-76248.003324</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>7</td>
      <td>-81494.536520</td>
      <td>-77091.777334</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>8</td>
      <td>-82186.107256</td>
      <td>-77928.152086</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>9</td>
      <td>-82894.603699</td>
      <td>-78756.530110</td>
      <td>00:37</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-153-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>learn64.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-154-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>learn64.fit(<span class="dv">10</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-86657.574491</td>
      <td>-79573.140216</td>
      <td>00:35</td>
    </tr>
    <tr>
      <td>1</td>
      <td>-87143.921928</td>
      <td>-80384.996341</td>
      <td>00:43</td>
    </tr>
    <tr>
      <td>2</td>
      <td>-87653.250792</td>
      <td>-81185.383657</td>
      <td>00:45</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-88184.467731</td>
      <td>-81975.397867</td>
      <td>00:38</td>
    </tr>
    <tr>
      <td>4</td>
      <td>-88736.205979</td>
      <td>-82756.360199</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>5</td>
      <td>-89307.081899</td>
      <td>-83533.464376</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>6</td>
      <td>-89896.712727</td>
      <td>-84295.158996</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>7</td>
      <td>-90502.884036</td>
      <td>-85052.112339</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>8</td>
      <td>-91124.668980</td>
      <td>-85800.350872</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>9</td>
      <td>-91760.654757</td>
      <td>-86534.885982</td>
      <td>00:36</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-155-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>learn64.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-156-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>learn64.fit(<span class="dv">10</span>, <span class="fl">5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-96583.857095</td>
      <td>-90116.492423</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>1</td>
      <td>-98577.199051</td>
      <td>-92925.633742</td>
      <td>00:45</td>
    </tr>
    <tr>
      <td>2</td>
      <td>-100214.210476</td>
      <td>-94781.564924</td>
      <td>00:44</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-101592.539368</td>
      <td>-96138.153983</td>
      <td>00:38</td>
    </tr>
    <tr>
      <td>4</td>
      <td>-102778.950141</td>
      <td>-97251.778337</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>5</td>
      <td>-103848.105282</td>
      <td>-98352.101810</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>6</td>
      <td>-104865.594222</td>
      <td>-99429.298098</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>7</td>
      <td>-105842.855027</td>
      <td>-100336.471012</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>8</td>
      <td>-106750.634687</td>
      <td>-101049.171852</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>9</td>
      <td>-107588.504449</td>
      <td>-101657.045583</td>
      <td>00:36</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-157-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>learn64.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-158-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>learn64.fit(<span class="dv">10</span>, <span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-112023.750583</td>
      <td>-103067.672828</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>1</td>
      <td>-112880.761990</td>
      <td>-104563.835248</td>
      <td>00:45</td>
    </tr>
    <tr>
      <td>2</td>
      <td>-113820.012790</td>
      <td>-106027.631600</td>
      <td>00:41</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-114758.363041</td>
      <td>-107296.752755</td>
      <td>00:38</td>
    </tr>
    <tr>
      <td>4</td>
      <td>-115682.264561</td>
      <td>-108321.534867</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>5</td>
      <td>-116538.934787</td>
      <td>-109323.722561</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>6</td>
      <td>-117377.241894</td>
      <td>-110144.798589</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>7</td>
      <td>-118166.549884</td>
      <td>-110973.624153</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>8</td>
      <td>-118951.102405</td>
      <td>-111826.504995</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>9</td>
      <td>-119722.472790</td>
      <td>-112614.036786</td>
      <td>00:36</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-159-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>learn64.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-160-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>from scractch</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>model64 <span class="op">=</span> KalmanFilter.init_random(hai.shape[<span class="dv">1</span>], hai.shape[<span class="dv">1</span>], dtype<span class="op">=</span>torch.float64).cuda()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>model.use_smooth <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>learn64.fit(<span class="dv">20</span>, <span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>-123781.406319</td>
      <td>-113518.751519</td>
      <td>00:38</td>
    </tr>
    <tr>
      <td>1</td>
      <td>-124302.026072</td>
      <td>-114360.961029</td>
      <td>00:45</td>
    </tr>
    <tr>
      <td>2</td>
      <td>-124835.244974</td>
      <td>-115219.247475</td>
      <td>00:42</td>
    </tr>
    <tr>
      <td>3</td>
      <td>-125407.806924</td>
      <td>-116079.809957</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>4</td>
      <td>-125992.022272</td>
      <td>-116876.937835</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>5</td>
      <td>-126591.485683</td>
      <td>-117669.170540</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>6</td>
      <td>-127205.480292</td>
      <td>-118498.006703</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>7</td>
      <td>-127843.942878</td>
      <td>-119269.656513</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>8</td>
      <td>-128509.574182</td>
      <td>-120222.595019</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>9</td>
      <td>-129232.020071</td>
      <td>-121277.182690</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>10</td>
      <td>-129996.530801</td>
      <td>-122188.783527</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>11</td>
      <td>-130703.871435</td>
      <td>-122179.642474</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>12</td>
      <td>-131238.940622</td>
      <td>-121853.057130</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>13</td>
      <td>-131674.850348</td>
      <td>-122101.548129</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>14</td>
      <td>-132054.565750</td>
      <td>-122233.606162</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>15</td>
      <td>-132415.641215</td>
      <td>-122850.742048</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>16</td>
      <td>-132864.252155</td>
      <td>-123754.810917</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>17</td>
      <td>-133397.242796</td>
      <td>-124578.902176</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>18</td>
      <td>-133964.768058</td>
      <td>-125188.553447</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>19</td>
      <td>-134569.991778</td>
      <td>-125950.532304</td>
      <td>00:36</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-163-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>learn64.recorder.plot_loss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="10_fastai_files/figure-html/cell-164-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>